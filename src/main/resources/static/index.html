<!doctype html>
<html lang="en">
<head>
	<title>Map Visualizer on OpenShift 3</title>
	<link rel="stylesheet" href="leaflet/leaflet.css"/>
	<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="leaflet/markercluster/MarkerCluster.css"/>
	<link rel="stylesheet" href="leaflet/markercluster/MarkerCluster.Default.css"/>
<!--
	<link href="leaflet/easyButton/easy-button.css" rel="stylesheet"/>
-->
	<script src="leaflet/leaflet.js"></script>
	<script src="leaflet/markercluster/leaflet.markercluster.js"></script>
<!--
	<script src="leaflet/easyButton/easy-button.js"></script>
-->
	<script src="jquery-3.1.0.min.js"></script>
    <!-- For websockets -->
    <script src="sockjs-1.1.0.js"></script>
    <script src="stomp.js"></script>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

	<style type="text/css">
		body {
			padding: 0;
			margin: 0;
		}

		html, body, #map {
			height: 100%;
			font-family: 'Oswald';
		}

		.leaflet-container .leaflet-control-zoom {
			margin-left: 13px;
			margin-top: 70px;
		}

		#map {
			z-index: 1;
		}

		#title {
			z-index: 2;
			position: absolute;
			left: 10px;
		}
	</style>
</head>

<body>
<h1 id="title" class="title">Map Visualizer on OpenShift 3</h1>
<div id="map"></div>

<script>
/*

 backend{
    id: "name";
    displayName: "displayName";
    center: ["",""],
    zoom: 1,
    visible: true,
    layer: L.markerClusterGroup()
 };
 */
    /************************
     * BEGIN OF WEBSOCKETS COMM
     ************************/
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/socks-backends');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            // console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/add', function(message){
                var backend = getBackend(JSON.parse(message.body));
                addBackend(backend);
            });
            stompClient.subscribe('/topic/remove', function(message){
                var backend = getBackend(JSON.parse(message.body));
                removeBackend(backend.id);
            });
        });
    }
    // TODO: Reconnect automatically. When redeploying application, need to reconnect, otherwise page needs to be reloaded
    // Look for solution like: https://github.com/jmesnil/stomp-websocket/issues/81#issuecomment-246854734

    var getBackend = function(backendFromServer){
        var backend = {
            id: backendFromServer.id,
            displayName: backendFromServer.displayName,
            center: backendFromServer.center,
            zoom: backendFromServer.zoom,
            visible: true,
            layer: new L.markerClusterGroup()
        };
        return backend;
    }

    function disconnect() {
        if (stompClient != null) {
            stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
    }


    /************************
     * END OF WEBSOCKETS COMM
     ************************/

	var backends = new Map();

	var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';


	var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
			streets = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr});

	var map = L.map('map', {
		center: [27.60567, -18.19336],
		zoom: 3,
		layers: [grayscale]
	});

	var baseLayers = {
		"Grayscale": grayscale,
		"Streets": streets
	};

	var overlays = {};

	var controls = L.control.layers(baseLayers, overlays, {collapsed:false} );
	controls.addTo(map);

	function addBackend(backend){
		console.log("Adding layer for backend: " + backend.id);

        // Check that the backend (by name did not exist, in which case, we'll remove the old one)
        if (backends.has(backend.id)){
            console.log("Removing old backend: " + backend.id);
            removeBackend(backend.id);
        }

        backends.set(backend.id, backend);

		map.addLayer(backend.layer);
		controls.addOverlay(backend.layer, backend.displayName);

        // Expected dataPoint { name, latitude, longitude, additionalInfo }
		$.get("/ws/data/all?service="+backend.id, function(data){
			for (var i = 0; i < data.length; i++){
				dataPoint = data[i];
				var popupInformation = "<b>" + dataPoint.name + "</b></br>";
				// TODO: Work additionalInfo
				var marker = L.marker([dataPoint.latitude, dataPoint.longitude]).bindPopup(popupInformation);
				// console.log("Data: " + dataPoint.name + " ("+ dataPoint.latitude + "," + dataPoint.longitude + ")=" + popupInformation);
				marker.addTo(backend.layer);
			}
		}, "json");

		// Focus map on the backend center and zoom
		map.setView([backend.center.latitude, backend.center.longitude], backend.zoom);
	}

	function removeBackend(backendId){
	    if (backends.has(backendId)) {
            var backend = backends.get(backendId);
            controls.removeLayer(backend.layer);
            map.removeLayer(backend.layer);
            backends.delete(backend.id);
        } else{
            console.log("Trying to remove a non existant backend: " + backendId);
        }
	}

	function initialLoad(){
		backends.clear();
		$.get("/ws/backends/list", function(data){
			for (var i = 0; i < data.length; i++){
				var backendFromServer = data[i];
				var backend = getBackend(backendFromServer);
                addBackend(backend);
			}
		}, "json");
	}

	// Set a timeout to load/unload backends
	setTimeout(function(){
		// Get notified of registrations/unregistrations

	}, 5000);

	map.whenReady(initialLoad).whenReady(connect);
	map.on('moveend', function() {
		console.log("map was panned!");
		console.log("zoom: " + map.getZoom());    // prints out zoom level
		console.log("center: " + map.getCenter());    // prints out map center
	});

</script>
</body>
</html>
